継続的インテグレーション(CI)の手引き
=====================

概要
---------------------
RCCでは，総会文書のビルドをCIツールを用いて自動化しています．
ビルド自動化のメリットは，ビルドの手間を減らすことができるということに尽きるでしょう．
現在の設定では，developブランチへの変更をすぐにビルドして，Slackの #soukai チャンネルにPDFをアップロードするようになっています．
こうして，最新の総会文書をいつでも入手できます．

この文書では，CIの設定方法について解説します．

Werckerを用いたCI
---------------------
本章では，Werckerを用いたCIの設定方法を説明します．

### Werckerとは
[Wercker](http://wercker.com/) (ワーカー) は，継続的インテグレーションを支援するサービスです．
Werckerはリポジトリ単位で，ビルドやデプロイを行ってくれるというものです．
恐らく，有名なCircleCIと類似したサービスだと思ってもらって構わないでしょう．

Werckerの特徴は，非常に柔軟性が高いことです．
プロジェクトに合わせて好きなDockerコンテナを選ぶことができ，その上でビルドやデプロイをすることができます．
ビルド手順やデプロイ手順も，設定ファイルを通してを柔軟に指定することができます．

### ビルドとデプロイの動作の流れ
1. ユーザがコミットをBitbucketのリモートリポジトリにプッシュする
2. プッシュされると，BitbucketのサービスはWerckerに通知を行う(サービス連携機能)
3. Werckerは，Bitbucketからリポジトリをクローンして，wercker.ymlにしたがってビルドとデプロイを行う．

### 作業手順
ビルドの設定に必要な手順を最初から順に示します．
1〜4の作業が終わると，自動ビルドが行えるようになっていると思われます．
`setup.rb`を使ったセットアップ作業をしながら，ビルドが行えるかどうか確認してみてください．

#### 1. 前準備
1. Bitbucketのアカウントはお持ちでしょうか？ まだなら，システム管理局に作ってもらうように頼みましょう．
2. BitbucketのRCCチームには参加できていますか？ まだなら，システム管理局に招待するように頼みましょう．
3. Bitbucketの総会リポジトリは，作成済みですか？ まだであれば，soukai-templateをフォークして新たな総会リポジトリを作りましょう．総会リポジトリの名前は，例年のフォーマット (soukai-XXXX-X) に従うと良いでしょう．
4. Bitbucketの管理権限を持っていますか？ まだであれば，システム管理局に設定してもらうように頼むか，システム管理局に当該作業を代行してもらいましょう．
5. WerckerのRCCのOrganizationに参加します．前担当者や執行委員長に招待するように頼みましょう．
6. Slackの[Botユーザ](https://ritscc.slack.com/apps/manage/custom-integrations)のアクセストークンを確認します．Slackへの通知には，`wercker`を使用しています．アクセストークンがわからない場合は，新しくBotを作成する必要があります．古いものは削除しておくと良いでしょう（要管理者権限？）．アクセストークンをいつでもコピーできるようにしておいてください．

#### 2. Werckerでのアプリケーション追加
まずは，Werckerにリポジトリを登録するところから始めます．
[Werckerのアプリケーション作成ページ](https://app.wercker.com/#applications/create)にアクセスして，次の通り作業を行ってください．

1. "Choose a Git provider"で，Bitbucketを選択して，次のステップに移ります．
2. "Select a repository"では，ビルドを行いたい総会リポジトリを選択し，"Use selected Repo"をクリックします．ここでは，"soukai-2015-1"を選択したとします．
3. "Select Owner"では，"rcc"を選択し，"Use selected owner"をクリックします．この項目が表示されない場合，1.3がうまく行えていません．
4. "Configure access"では，1番目の"Add the deploy key to the selected repository for me"を選択し，"Next step"をクリックします．  
	（Bitbucketのリポジトリ設定でSSHデプロイキーとサービス連携が自動的に設定されます）
5. "Setup your wercker.yml"では，リポジトリのwercker.ymlを正常に読み込めるかがチェックされます．エラーが表示されなければ，"Next step"をクリックします．
6. "Awesome! You are all done!"では，"Make my app public"にチェックを入れないでそのまま何もせずに"Finish"をクリックしてください．

#### 3. WerckerとBitbucketでのビルドの詳細設定
ここでは，WerckerのDockerコンテナ内からBitbucketのプライベートリポジトリを読み込むために，
WerckerでSSHキーを生成して，それをBitbucketに登録する手順を説明します．

1. Werckerに追加した総会リポジトリのアプリケーションページで，上にあるタブの"Environment"をクリックして，環境変数設定ページを開きます．
2. ページの一番下にある，入力欄（空欄になっている部分）まで移動します．
3. Nameの入力欄には，`FOR_SUB_MODULE`と入力します．SSH-Keypairが，"Generate new SSH key-pair"になっていることを確認します．
4. "Add"ボタンをクリックして，SSHキーを生成します．
5. "for\_sub\_module"の表記の下に，SSHパブリックキーが表示されます．クリックするとすべて選択されます．これをコピーしておいてください．
6. Bitbucketに，`ritscc_deploy`ユーザでログインします．ログイン方法はWikiに載っています．また，前任者やシステム管理局に聞いても分かるでしょう．
7. [Bitbucketのritscc\_deployユーザのSSHキー設定ページ](https://bitbucket.org/account/user/ritscc_deploy/ssh-keys/)を開きます．
8. "鍵を追加"ボタンを押すと，SSHキーの追加ウィンドウが表示されます．
9. "Label"に`RCC Wercker for soukai-XXXX-X (for submodule)`(XXXXの部分は読み替えてください)と入力し，"Key"入力欄に先ほどコピーしておいたパブリックキーをペーストします．入力が終わったら，鍵を追加ボタンを押します．
10. Werckerに追加した総会リポジトリのアプリケーションページで，"Workflow"をクリックしてワークフロー設定ページを開きます．
11. 一番下にある"Pipelines"に移動して，"build"と名前のついたパイプラインをクリックして，パイプライン設定ページに移動します．
12. パイプライン設定ページの一番下にある"Settings"の"Report to SCM"にチェックを入れて，右下の"Update"ボタンをクリックします．こうするとGitHub の Pull Request 画面にパイプラインの実行結果を反映できます．

#### 4. デプロイ設定
デプロイとは，英語で「展開」「配置」を意味し，CIでいうとビルドしたソフトウェアを利用可能な状態に自動構成することをいいます．
しかし，総会文書はソフトウェアではなく文書なので，ソフトウェアとは違った「デプロイ」を行います．
総会文書のデプロイ設定では，Slackの #soukai チャンネルに自動的に生成したPDFをアップロードしてくれるようにしています．
ここでは，デプロイ設定の手順を説明します．

1. Werckerに追加した総会リポジトリのアプリケーションページで，"Workflow"をクリックしてワークフロー設定ページを開きます．
2. 一番下の"Pipelines"の項まで移動します．
3. "Add new pipeline"ボタンをクリックして，新しいパイプラインを設定します．
4. "Name"の入力欄に`Slack_Upload`と入力，"YML Pipeline name"には`deploy`と入力，"Hook type"は`default`を選択します．完了したら，"Create"ボタンをクリックします．
5. "Environment variables"の項の入力欄に移動します．
6. "Name"に`SLACK_TOKEN`と入力し，"Value"の入力欄には，1.6で確認したSlackのアクセストークンを入力します．
7. 入力が完了したら，"Add"ボタンを押して，設定を反映します．
8. 再び"Workflow"をクリックしてワークフロー設定ページを開きます．
9. 一番上の"Editor"の項で，"build"の右横にある"＋"ボタンをクリックします．
10. "On Branch"の入力欄に，`master develop`と入力します．これで，masterブランチとdevelopブランチのビルド完了時に，パイプラインが実行されます．
11. "Execute pipeline"は，先ほど作成したパイプライン`Slack_Upload`を指定します．
12. 完了したら，"Add"ボタンをクリックします．

#### 5. 自動コメント設定
Werckerでビルドテストした結果をプルリクエストに自動でコメントすることができます．
ここでは，その設定方法を説明します．

1. Bitbucketの総会リポジトリに移動し， Settings > アクセス管理 から`ritscc_deploy`ユーザをREAD権限で追加します．
2. Werckerに追加した総会リポジトリのアプリケーションページで，上にあるタブの"Environment"をクリックして，環境変数設定ページを開きます．
3. 同様に環境変数を追加します．"Environment variables"の項の空の入力欄に移動します．
4. "Variable name"に`BITBUCKET_USER`，"Value"に`ritscc_deploy`を入力してAddボタンを押します．
5. 更にもう一つ環境変数を追加します．"Variable name"に`BITBUCKET_PASS`，"Value"にritscc\_deployのパスワードをBase64エンコードした文字列を入力してAddボタンを押します．この時`Protected`のチェックボックスにチェックを入れておきます．Base64エンコードする際は，ローカルのPCの`base64`コマンドを用いるなどして，オンラインにパスワードを送信しないように注意してください．

### カスタマイズ
カスタマイズを行ってくれる人を募集しています．総会文書の執筆をよりよくするようなソリューションを待っています．

今のところ，プルリクエストのコメントにビルドしたPDFへのリンクや，
文章チェックソフトウェアのta9bohによる指摘点を自動で記入できるようになることを目指しています．
これにより，プルリクエストが更新されるたびに，（総会文書のレビューをするために）時間のかかる面倒なビルドする必要がなくなり，
文書の相互レビューがしやすくなることが期待できます．また，執筆者は必ずしも自分の環境でビルドする必要がなくなり，pLaTeX環境の導入の負担が減るでしょう．
また，誰もが犯すような細かなミスは，人手でなくta9bohが自動的にやってくれるので，レビュアーは文章の内容に集中できるようになります．

本リポジトリのwercker.ymlには，Werckerサービス上で動いているDockerコンテナ内で行なわれるビルドとデプロイの手順が記述されています．
このファイルを変更することで，ビルドの動作やデプロイの方法を変更することが可能です．
設定方法については，[Werckerによる説明ページ](http://devcenter.wercker.com/learn/basics/configuration.html)を参照してください．
動作確認やローカルで動作させるには，ローカル環境で実行できる[Wercker CLI](http://wercker.com/cli/install/)が便利です．
なお，Wercker CLIが動作するOSは，Linuxか，OS X (macOS)です．
